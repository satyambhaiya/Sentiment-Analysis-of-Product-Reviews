import tkinter as tk
from tkinter import scrolledtext, END
import joblib
import re
from bs4 import BeautifulSoup
import nltk
from nltk.corpus import stopwords
from nltk.stem import WordNetLemmatizer


try:
    lemmatizer = WordNetLemmatizer()
    stop_words = set(stopwords.words('english'))
    # Try to access the data to check if it's downloaded
    _ = lemmatizer.lemmatize("test")
    _ = "test" in stop_words
except LookupError:
    print("NLTK data (stopwords, wordnet) not found.")
    print("Please run the NLTK download cells in your Jupyter Notebook first.")
    nltk.download('stopwords')
    nltk.download('wordnet')
    lemmatizer = WordNetLemmatizer()
    stop_words = set(stopwords.words('english'))


def preprocess_text(text):
    """Cleans a single piece of text for prediction."""
    try:
        # 1. Remove HTML tags
        text = BeautifulSoup(text, "html.parser").get_text()
        
        # 2. Remove punctuation and numbers (keep only letters)
        text = re.sub(r'[^a-zA-Z]', ' ', text)
        
        # 3. Convert to lowercase
        text = text.lower()
        
        # 4. Tokenization (split into words)
        tokens = text.split()
        
        # 5. Remove stop words and lemmatize
        cleaned_tokens = []
        for word in tokens:
            if word not in stop_words:
                cleaned_tokens.append(lemmatizer.lemmatize(word))
        
        # 6. Join tokens back into a single string
        return " ".join(cleaned_tokens)
    except Exception as e:
        print(f"Error in preprocessing: {e}")

try:
    vectorizer = joblib.load('tfidf_vectorizer.joblib')
    model = joblib.load('sentiment_model_log.joblib')
    print("Model and vectorizer loaded successfully.")
except FileNotFoundError:
    print("Error: Model or vectorizer files not found.")
    print("Please run the 'sentiment_analysis_notebook.py' (cell 12) to save the files.")
    # We'll set them to None so the GUI can show an error
    vectorizer = None
    model = None
except Exception as e:
    print(f"An error occurred loading files: {e}")
    vectorizer = None
    model = None




def predict_sentiment():
    """Gets text from the input box, predicts, and shows the result."""
    if not model or not vectorizer:
        result_label.config(text="Error: Model files not loaded.", fg="red")
        return

    # 1. Get text from the text box
    raw_text = text_input.get("1.0", END).strip()
    
    if not raw_text:
        result_label.config(text="Please enter a review.", fg="orange")
        return

    try:
        # 2. Clean the text
        cleaned_text = preprocess_text(raw_text)
        
        # 3. Transform using the loaded vectorizer
        # We put [cleaned_text] in a list because transform expects an iterable
        text_tfidf = vectorizer.transform([cleaned_text])
        
        # 4. Predict using the loaded model
        prediction = model.predict(text_tfidf)
        
        # 5. Get prediction probabilities
        probability = model.predict_proba(text_tfidf)
        
        # 6. Format and display the result
        confidence = probability[0][prediction[0]] * 100
        
        if prediction[0] == 1:
            sentiment = "Positive"
            color = "green"
        else:
            sentiment = "Negative"
            color = "red"
            
        result_label.config(
            text=f"Prediction: {sentiment} ({confidence:.2f}% confident)",
            fg=color
        )
    except Exception as e:
        result_label.config(text=f"An error occurred: {e}", fg="red")

def clear_text():
    """Clears the input box and the result label."""
    text_input.delete("1.0", END)
    result_label.config(text="Enter a review above and click 'Analyze'", fg="black")


# --- Create the GUI ---

# Main window
root = tk.Tk()
root.title("Movie Review Sentiment Analyzer")
root.geometry("600x400")
root.configure(bg="#f0f0f0")

# Main frame
main_frame = tk.Frame(root, bg="#f0f0f0")
main_frame.pack(expand=True, fill="both", padx=20, pady=20)

# Title Label
title_label = tk.Label(
    main_frame, 
    text="Sentiment Analyzer", 
    font=("Helvetica", 20, "bold"), 
    bg="#f0f0f0"
)
title_label.pack(pady=(0, 15))

# Input Text Area
input_label = tk.Label(
    main_frame, 
    text="Enter your review below:", 
    font=("Helvetica", 12), 
    bg="#f0f0f0"
)
input_label.pack()

text_input = scrolledtext.ScrolledText(
    main_frame, 
    width=60, 
    height=10, 
    wrap=tk.WORD, 
    font=("Helvetica", 11),
    bd=1,
    relief="solid"
)
text_input.pack(pady=10, fill="x", expand=True)

# Button Frame
button_frame = tk.Frame(main_frame, bg="#f0f0f0")
button_frame.pack()

# Analyze Button
analyze_button = tk.Button(
    button_frame, 
    text="Analyze", 
    font=("Helvetica", 12, "bold"),
    command=predict_sentiment,
    bg="#007bff",
    fg="white",
    relief="raised",
    padx=10,
    pady=5
)
analyze_button.pack(side="left", padx=10)

# Clear Button
clear_button = tk.Button(
    button_frame, 
    text="Clear", 
    font=("Helvetica", 12),
    command=clear_text,
    bg="#6c757d",
    fg="white",
    relief="raised",
    padx=10,
    pady=5
)
clear_button.pack(side="left", padx=10)

# Result Label
result_label = tk.Label(
    main_frame, 
    text="Enter a review above and click 'Analyze'", 
    font=("Helvetica", 14, "italic"), 
    bg="#f0f0f0",
    pady=15
)
result_label.pack()

# --- Run the GUI ---
if __name__ == "__main__":
    if not model or not vectorizer:
        # Show an error in the GUI if models didn't load
        result_label.config(
            text="CRITICAL ERROR: Model files not found.\nPlease run the notebook to create them.",
            fg="red",
            font=("Helvetica", 10, "bold")
        )
    root.mainloop()

